<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.prometheus</groupId>
        <artifactId>client_java</artifactId>
        <version>1.0.0-alpha-1-SNAPSHOT</version>
    </parent>

    <artifactId>protobuf-shaded</artifactId>
    <name>Shaded (relocated to another package) Protobuf</name>
    <description>
        Downloads Google Protobuf, compiles it, and reloacates/shades.
        See also hbase-thirdparty/hbase-shaded-protobuf
    </description>

    <properties>
        <!-- Must be the same as the version of the protoc command that generated Metrics.java -->
        <!-- in the Prometheus protobuf exposition format. -->
        <protobuf.version>3.21.7</protobuf.version>
        <!-- The version string is part of the relocated package name to make it safe to update in the future. -->
        <protobuf.version.string>3_21_7</protobuf.version.string>
    </properties>

    <build>
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <!-- include the protos -->
                    <include>google/**</include>
                </includes>
            </resource>
        </resources>
        <plugins>
            <plugin>
                <!--Clean needs to purge src/main/java since this is where
                     the unpack of protobuf is overlaid. Do it for usual
                     clean goal but also before we unpack in case patches
                     delete/add files. We use src/main/java instead of dir
                     under 'target' because the jar plugin is dumb, hard to
                     make it source from other then src/main/java.-->
                <artifactId>maven-clean-plugin</artifactId>
                <executions>
                    <execution>
                        <id>pre-generate-sources</id>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>clean</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <filesets>
                        <fileset>
                            <directory>${basedir}/src/main/java</directory>
                            <includes>
                                <include>**/**</include>
                            </includes>
                            <followSymlinks>false</followSymlinks>
                        </fileset>
                    </filesets>
                </configuration>
            </plugin>
            <plugin>
                <!--Download our dependency src, i.e. protobuf, and
                     unpack it. Overlays src/main/java so ready for
                    compile-time (the jar plugin expects src in
                    src/main/java)-->
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>unpack</id>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <!--
                              The protobuf-java has no compile or runtime dependency so we
                              only depend it here, without adding it to our dependencies
                              section. Need to review later if protobuf-java has compile or
                              runtime dependencies in the future.
                            -->
                            <artifactItems>
                                <artifactItem>
                                    <groupId>com.google.protobuf</groupId>
                                    <artifactId>protobuf-java</artifactId>
                                    <!-- must be the same as the version of the protoc command that generated Metrics.java -->
                                    <version>3.21.7</version>
                                    <classifier>sources</classifier>
                                    <type>jar</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${basedir}/src/main/java</outputDirectory>
                                    <includes>**/**</includes>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-source-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>google/protobuf/*.proto</exclude>
                        <exclude>google/protobuf/compiler/*.proto</exclude>
                    </excludes>
                </configuration>
                <executions>
                    <execution>
                        <id>attach-sources</id>
                        <goals>
                            <goal>jar-no-fork</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <!--Above we built a jar. Now at package step, do relocation/shade-->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <shadeSourcesContent>true</shadeSourcesContent>
                            <createSourcesJar>true</createSourcesJar>
                            <relocations>
                                <relocation>
                                    <pattern>com.google.protobuf</pattern>
                                    <shadedPattern>
                                        io.prometheus.metrics.com_google_protobuf_${protobuf.version.string}
                                    </shadedPattern>
                                </relocation>
                            </relocations>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>google/protobuf/*.proto</exclude>
                        <exclude>google/protobuf/compiler/*.proto</exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <artifactId>maven-javadoc-plugin</artifactId>
                <configuration>
                    <!-- The upstream protobuf classes have JavaDoc errors. Ignore them. -->
                    <excludePackageNames>com.google.protobuf</excludePackageNames>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
